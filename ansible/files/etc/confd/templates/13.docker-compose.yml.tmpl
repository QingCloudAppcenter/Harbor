cat > /opt/app/conf/docker-compose.yml << DOCKER_COMPOSE_FILE
version: '2'
services:
  {{- if eq $nodeRole "log" }}
  log:
    image: goharbor/harbor-log:v1.7.1
    container_name: log
    restart: always
    networks:
      - harbor
    dns_search: .
    ports:
      - 1514:10514
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - SETGID
      - SETUID
    volumes:
      - /var/log/harbor/:/var/log/docker/:z
      - ./log/rsyslog.conf:/etc/rsyslog.d/rsyslog_docker.conf:z
      - ./log/logrotate.conf:/etc/logrotate.d/logrotate.conf:z
    logging:
      driver: "syslog"
      options:
        tag: "harbor.log"
  {{- end }}
  {{- if eq $nodeRole "storage" }}
  storage:
    image: erichough/nfs-server:1.2.0
    container_name: nfs-server
    restart: always
    privileged: true
    volumes:
      - /data/registry:/registry:rw
      - ./nfs-server/exports:/etc/exports:ro
    networks:
      - harbor
    ports:
      - 111:111
      - 2049:2049
      - 32765:32765
      - 32767:32767
    logging:
      driver: "syslog"
      options:
        syslog-address: "tcp://log:1514"
        tag: "storage.nfs"
  {{- end }}
  {{- if eq $nodeRole "cache" }}
  redis:
    image: goharbor/redis-photon:v1.7.1
    container_name: redis
    restart: always
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
    volumes:
      - /data/redis:/var/lib/redis
      - ./redis/redis.conf:/etc/redis.conf
    networks:
      - harbor
    dns_search: .
    ports:
      - 6379:6379
    logging:
      driver: "syslog"
      options:
        syslog-address: "tcp://log:1514"
        tag: "cache.redis"
  {{- end }}
  {{- if eq $nodeRole "db" }}
  postgresql:
    image: goharbor/harbor-db:v1.7.1
    container_name: db
    env_file:
      - ./db/env
    restart: always
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - DAC_OVERRIDE
      - SETGID
      - SETUID
    volumes:
      - /data/database/app-1.2.0:/var/lib/postgresql/data:z
    networks:
      - harbor
    dns_search: .
    ports:
      - 5432:5432
    logging:
      driver: "syslog"
      options:
        syslog-address: "tcp://log:1514"
        tag: "db.postgres"
  {{- end }}
  {{- range getvs "/host/role" | filter "web|job" }}
  registry:
    image: goharbor/registry-photon:v2.6.2-v1.7.1
    container_name: registry
    restart: always
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
    volumes:
      - /data/registry:/storage:z
      - ./registry/:/etc/registry/:z
      - ./custom-ca-bundle.crt:/harbor_cust_cert/custom-ca-bundle.crt:z
    networks:
      - harbor
    dns_search: .
    extra_hosts:
      - redis:{{ range getvs "/hosts/cache_node/*/ip" }}{{ . }}{{ end }}
    logging:
      driver: "syslog"
      options:
        syslog-address: "tcp://log:1514"
        tag: "{{ $nodeRole }}.registry"
  registryctl:
    image: goharbor/harbor-registryctl:v1.7.1
    container_name: registryctl
    env_file:
      - ./registryctl/env
    restart: always
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
    volumes:
      - /data/registry:/storage:z
      - ./registry/:/etc/registry/:z
      - ./registryctl/config.yml:/etc/registryctl/config.yml:z
    networks:
      - harbor
    dns_search: .
    logging:
      driver: "syslog"
      options:
        syslog-address: "tcp://log:1514"
        tag: "{{ $nodeRole }}.registryctl"
  adminserver:
    image: goharbor/harbor-adminserver:v1.7.1
    container_name: adminserver
    env_file:
      - ./adminserver/env
    restart: always
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
    volumes:
      - /data/config/:/etc/adminserver/config/:z
      - /data/secretkey:/etc/adminserver/key:z
      - /data/:/data/:z
    networks:
      - harbor
    dns_search: .
    extra_hosts:
      - postgresql:{{ range getvs "/hosts/db_node/*/ip" }}{{ . }}{{ end }}
    logging:
      driver: "syslog"
      options:
        syslog-address: "tcp://log:1514"
        tag: "{{ $nodeRole }}.adminserver"
  core:
    image: goharbor/harbor-core:v1.7.1
    container_name: core
    env_file:
      - ./core/env
    restart: always
    cap_drop:
      - ALL
    cap_add:
      - SETGID
      - SETUID
    volumes:
      - ./core/app.conf:/etc/core/app.conf:z
      - ./core/private_key.pem:/etc/core/private_key.pem:z
      - ./core/certificates/:/etc/core/certificates/:z
      - /data/secretkey:/etc/core/key:z
      - /data/ca_download/:/etc/core/ca/:z
      - /data/psc/:/etc/core/token/:z
      - /data/:/data/:z
    networks:
      - harbor
    dns_search: .
    extra_hosts:
      - redis:{{ range getvs "/hosts/cache_node/*/ip" }}{{ . }}{{ end }}
      - postgresql:{{ range getvs "/hosts/db_node/*/ip" }}{{ . }}{{ end }}
      {{- range getvs "/hosts/job_node/*/ip" }}
      - jobservice:{{ . }}
      {{- end }}
    depends_on:
      - adminserver
      - registry
    logging:
      driver: "syslog"
      options:
        syslog-address: "tcp://log:1514"
        tag: "{{ $nodeRole }}.core"
  {{- end }}
  {{- if eq $nodeRole "job" }}
  jobservice:
    image: goharbor/harbor-jobservice:v1.7.1
    container_name: jobservice
    env_file:
      - ./jobservice/env
    restart: always
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
    volumes:
      - /data/job_logs:/var/log/jobs:z
      - ./jobservice/config.yml:/etc/jobservice/config.yml:z
    networks:
      - harbor
    dns_search: .
    ports:
      - 8080:8080
    extra_hosts:
      - redis:{{ range getvs "/hosts/cache_node/*/ip" }}{{ . }}{{ end }}
      - postgresql:{{ range getvs "/hosts/db_node/*/ip" }}{{ . }}{{ end }}
    depends_on:
      - core
      - adminserver
    logging:
      driver: "syslog"
      options:
        syslog-address: "tcp://log:1514"
        tag: "job.jobservice"
  {{- end }}
  {{- if eq $nodeRole "web" }}
  portal:
    image: goharbor/harbor-portal:v1.7.1
    container_name: portal
    restart: always
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
      - NET_BIND_SERVICE
    networks:
      - harbor
    dns_search: .
    depends_on:
      - core
    logging:
      driver: "syslog"
      options:
        syslog-address: "tcp://log:1514"
        tag: "web.portal"
  proxy:
    image: goharbor/nginx-photon:v1.7.1
    container_name: nginx
    restart: always
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETGID
      - SETUID
      - NET_BIND_SERVICE
    volumes:
      - ./nginx:/etc/nginx:z
    networks:
      - harbor
    dns_search: .
    ports:
      - 80:80
    depends_on:
      - registry
      - core
      - portal
    logging:
      driver: "syslog"
      options:
        syslog-address: "tcp://log:1514"
        tag: "web.proxy"
  {{- end }}

networks:
  harbor:
    external: false
    ipam:
      driver: default
      config:
        - subnet: 172.18.0.0/16
DOCKER_COMPOSE_FILE
